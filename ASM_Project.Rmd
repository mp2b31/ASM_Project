---
title: "ASM-Project"
author: "Eloi Campeny Roig & Maria Paraskeva"
date: "2023-12-20"
output: html_document
editor_options: 
  chunk_output_type: console
---

#Read Data
The chosen time series shows the apparent cement consumption in Spain (Construction Indicator) in thousands of tones.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load the data and print them by month.
```{r}
serie=window(ts(read.table("cemento.dat"),start=1990,freq=12))
print(round(serie,0))
```

Plot the time series. 
```{r}
plot(serie,main="Apparent cement consumption in Spain (Thousand of tones)")
abline(v=1990:2020,col=4,lty=3)
```

# Transformations
Calculate the mean and variance per month in a matrix of 12 rows (months). Then plot the values of the annual mean against annual variance. 
```{r}
m=apply(matrix(serie,nr=12),2,mean)
v=apply(matrix(serie,nr=12),2,var)
plot(m,v,xlab="Annual Mean",ylab="Annual Variance",main="Annual Mean against Annual Variance values")
abline(lm(v~m),col=2,lty=3,lwd=2)
```

Plot the cement consumption over the years so as to gain insights into potential trends or seasonal patterns in construction activity. 
```{r}
boxplot(serie ~ floor(time(serie)), main = "Distribution of Time Series Data Across Time", xlab = "Year", ylab = "Cement Consumption")
```

Make a log transformation and plot the results. 
```{r}
lnserie=log(serie)
plot(lnserie, xlab = "Time", ylab = "Log Data", main = "Log transformation of Data over Time")
```

Calculate the log mean and log variance per month in a matrix of 12 rows (months).
Plot log variance against log mean.
```{r}
m=apply(matrix(lnserie,nr=12),2,mean)
v=apply(matrix(lnserie,nr=12),2,var)
plot(m,v,xlab="Annual Log Mean",ylab="Annual Log Variance",main="Annual Log Mean against Annual Log Variance values")
abline(lm(v~m),col=2,lty=3,lwd=2)
```

Plot the log cement consumption over discrete time intervals. 
```{r}
boxplot(lnserie~floor(time(lnserie)), main = "Distribution of Log Data Across Time", xlab = "Year", ylab = "Log of Cement Consumption")
```

Plot the decomposition of additive time series. From top to bottom it shows:
Original time series
Trend Component
Seasonal Component
Residual Component
```{r}
plot(decompose(lnserie))
```

Seasonal plot of log data showing one subplot per month. The horizontal line in each subplot represents the mean value of the log-transformed time series. 
```{r}
monthplot(lnserie, main = "Seasonal plot of log data")
```

Plot the log-transformed data in a matrix format where each column is a different month. 
```{r}
ts.plot(matrix(lnserie,nrow=12),col=1:8, main = "Monthly Patterns in Log-Transformed Time Series Data")
```

Calculate the difference on the log data with a lag of 12. Then plot the results. 
```{r}
d12lnserie=diff(lnserie,12)
plot(d12lnserie)
abline(h=0)
abline(h=mean(d12lnserie),col=2)
```

Add a differencing to the previous series with a lag of 1 and plot the results. 
```{r}
d1d12lnserie=diff(d12lnserie,1)
plot(d1d12lnserie)
abline(h=0)
abline(h=mean(d1d12lnserie),col=2,lwd=2)
```

Add another differencing with a lag of 1 and plot the results. 
```{r}
d1d1d12lnserie=diff(d1d12lnserie,1)
plot(d1d1d12lnserie)
abline(h=0)
abline(h=mean(d1d12lnserie),col=2,lwd=2)
```

Show the variance of the transformed time series. The smaller is the d1d12lnserie. 
```{r}
var(lnserie)
var(d1d12lnserie)
var(d1d1d12lnserie)

```

Autocorrelation and partial autocorrelation function plots shown side by side for the differenced d1d12lnserie. 
```{r}
par(mfrow=c(1,2))
acf(d1d12lnserie,ylim=c(-1,1),col=c(2,rep(1,11)),lwd=2,lag.max=120)
pacf(d1d12lnserie,ylim=c(-1,1),col=c(rep(1,11),2),lwd=2,lag.max=120)
```

AR(2), AR(4), SAR(4)

# Models

```{r}
(mod1=arima(d1d12lnserie,order=c(2,0,0),seasonal=list(order=c(4,0,0),period=12)))
```

```{r}
abs(mod1$coef/sqrt(diag(mod1$var.coef)))
```

```{r}
(mod1=arima(lnserie,order=c(2,1,0),seasonal=list(order=c(4,1,0),period=12)))
```

```{r}
abs(mod1$coef/sqrt(diag(mod1$var.coef)))
```

```{r}
(mod2=arima(d1d12lnserie,order=c(4,0,0),seasonal=list(order=c(4,0,0),period=12)))
```

```{r}
abs(mod2$coef/sqrt(diag(mod2$var.coef)))
```

```{r}
(mod2=arima(lnserie,order=c(4,1,0),seasonal=list(order=c(4,1,0),period=12)))
```

```{r}
abs(mod2$coef/sqrt(diag(mod2$var.coef)))
```

```{r}
mod1$aic
mod2$aic
```


# Validation

```{r}
#################Validation#################################
validation=function(model,dades){
  s=frequency(get(model$series))
  resid=model$residuals
  par(mfrow=c(2,2),mar=c(3,3,3,3))
  #Residuals plot
  plot(resid,main="Residuals")
  abline(h=0)
  abline(h=c(-3*sd(resid),3*sd(resid)),lty=3,col=4)
  #Square Root of absolute values of residuals (Homocedasticity)
  scatter.smooth(sqrt(abs(resid)),main="Square Root of Absolute residuals",
                 lpars=list(col=2))
  
  #Normal plot of residuals
  qqnorm(resid)
  qqline(resid,col=2,lwd=2)
  
  ##Histogram of residuals with normal curve
  hist(resid,breaks=20,freq=FALSE)
  curve(dnorm(x,mean=mean(resid),sd=sd(resid)),col=2,add=T)
  
  
  #ACF & PACF of residuals
  par(mfrow=c(1,2))
  acf(resid,ylim=c(-1,1),lag.max=60,col=c(2,rep(1,s-1)),lwd=1)
  pacf(resid,ylim=c(-1,1),lag.max=60,col=c(rep(1,s-1),2),lwd=1)
  par(mfrow=c(1,1))
  
  #ACF & PACF of square residuals 
  par(mfrow=c(1,2))
  acf(resid^2,ylim=c(-1,1),lag.max=60,col=c(2,rep(1,s-1)),lwd=1)
  pacf(resid^2,ylim=c(-1,1),lag.max=60,col=c(rep(1,s-1),2),lwd=1)
  par(mfrow=c(1,1))
  
  #Ljung-Box p-values
  par(mar=c(2,2,1,1))
  tsdiag(model,gof.lag=7*s)
  cat("\n--------------------------------------------------------------------\n")
  print(model)
  
  #Stationary and Invertible
  cat("\nModul of AR Characteristic polynomial Roots: ", 
      Mod(polyroot(c(1,-model$model$phi))),"\n")
  cat("\nModul of MA Characteristic polynomial Roots: ",
      Mod(polyroot(c(1,model$model$theta))),"\n")
  
  suppressMessages(require(forecast,quietly=TRUE,warn.conflicts=FALSE))
  plot(model)
  
  #Model expressed as an MA infinity (psi-weights)
  psis=ARMAtoMA(ar=model$model$phi,ma=model$model$theta,lag.max=36)
  names(psis)=paste("psi",1:36)
  cat("\nPsi-weights (MA(inf))\n")
  cat("\n--------------------\n")
  print(psis[1:20])
  
  #Model expressed as an AR infinity (pi-weights)
  pis=-ARMAtoMA(ar=-model$model$theta,ma=-model$model$phi,lag.max=36)
  names(pis)=paste("pi",1:36)
  cat("\nPi-weights (AR(inf))\n")
  cat("\n--------------------\n")
  print(pis[1:20])
  
  cat("\nDescriptive Statistics for the Residuals\n")
  cat("\n----------------------------------------\n") 
  
  suppressMessages(require(fBasics,quietly=TRUE,warn.conflicts=FALSE))
  ##Anderson-Darling test
  print(basicStats(resid))
  
  ## Add here complementary tests (use with caution!)
  ##---------------------------------------------------------
  cat("\nNormality Tests\n")
  cat("\n--------------------\n")
 
  ##Shapiro-Wilks Normality test
  print(shapiro.test(resid(model)))

  suppressMessages(require(nortest,quietly=TRUE,warn.conflicts=FALSE))
  ##Anderson-Darling test
  print(ad.test(resid(model)))
  
  suppressMessages(require(tseries,quietly=TRUE,warn.conflicts=FALSE))
  ##Jarque-Bera test
  print(jarque.bera.test(resid(model)))
  
  cat("\nHomoscedasticity Test\n")
  cat("\n--------------------\n")
  suppressMessages(require(lmtest,quietly=TRUE,warn.conflicts=FALSE))
  ##Breusch-Pagan test
  obs=get(model$series)
  print(bptest(resid(model)~I(obs-resid(model))))
  
  cat("\nIndependence Tests\n")
  cat("\n--------------------\n")
  
  ##Durbin-Watson test
  print(dwtest(resid(model)~I(1:length(resid(model)))))
  
  ##Ljung-Box test
  cat("\nLjung-Box test\n")
  print(t(apply(matrix(c(1:4,(1:4)*s)),1,function(el) {
    te=Box.test(resid(model),type="Ljung-Box",lag=el)
    c(lag=(te$parameter),statistic=te$statistic[[1]],p.value=te$p.value)})))
  

  #Sample ACF vs. Teoric ACF
  par(mfrow=c(2,2),mar=c(3,3,3,3))
  acf(dades, ylim=c(-1,1) ,lag.max=36,main="Sample ACF")
  
  plot(ARMAacf(model$model$phi,model$model$theta,lag.max=36),ylim=c(-1,1), 
       type="h",xlab="Lag",  ylab="", main="ACF Teoric")
  abline(h=0)
  
  #Sample PACF vs. Teoric PACF
  pacf(dades, ylim=c(-1,1) ,lag.max=36,main="Sample PACF")
  
  plot(ARMAacf(model$model$phi,model$model$theta,lag.max=36, pacf=T),ylim=c(-1,1),
       type="h", xlab="Lag", ylab="", main="PACF Teoric")
  abline(h=0)
  par(mfrow=c(1,1))
}
################# Fi Validation #################################
```

```{r}
validation(mod2,d1d12lnserie )
```

# outlier treatment

```{r}
########## At√≠pics (Outliers) ###############################################
source("atipics2.r")
```

```{r}
# crit 2.9 cut be a good threahhold
mod.atip=outdetec(mod2,dif=c(1,12),crit=2.9,LS=T)
mod.atip$sigma
```

```{r}
atipics=mod.atip$atip[order(mod.atip$atip[,1]),]
meses=c("Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic")

data.frame(atipics,Fecha=paste(meses[(atipics[,1]-1)%%12+1],start(lnserie)[1]+((atipics[,1]-1)%/%12)),perc.Obs=exp(atipics[,3])*100)
```

```{r}
lnserie.lin=lineal(lnserie,mod.atip$atip)
serie.lin=exp(lnserie.lin)

plot(serie.lin,col=2)
lines(serie)
```

```{r}
plot(lnserie-lnserie.lin)
```

```{r}
d1d12lnserie.lin=diff(diff(lnserie.lin,12))
par(mfrow=c(1,2))
acf(d1d12lnserie.lin,ylim=c(-1,1),lag.max=72,col=c(2,rep(1,11)),lwd=2)
pacf(d1d12lnserie.lin,ylim=c(-1,1),lag.max=72,col=c(rep(1,11),2),lwd=2)
par(mfrow=c(1,1))
```

```{r}
(mod.lin=arima(lnserie.lin,order=c(4,1,0),seasonal=list(order=c(4,1,0),period=12)))
```

```{r}
validation(mod.lin,d1d12lnserie.lin)
```
